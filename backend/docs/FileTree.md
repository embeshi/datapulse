This file tree reflects the current structure of the backend application, incorporating FastAPI, Prisma, and various utility modules.

```
.
├── .env                     # Store API keys, DATABASE_URL (e.g., DATABASE_URL="sqlite:../analysis.db")
├── .env.local               # Example/local environment variables (used by llm/client.py)
├── .gitignore               # Git ignore rules
├── README.md                # Project description, setup, usage
├── analysis.db              # SQLite database file (generated by Prisma, often in root or specified by URL)
├── analysis_results/        # Directory for storing detailed dataset analysis JSON files
│   └── products_analysis.json
│   └── sales_analysis.json
│   └── ...
├── backend/                 # Root directory for all backend source code and tests
│   ├── requirements.txt     # Python dependencies (fastapi, uvicorn, openai, prisma, pandas, sqlalchemy, etc.)
│   ├── data/                # Sample input CSV data files
│   │   ├── customers.csv
│   │   ├── products.csv
│   │   └── sales.csv
│   ├── docs/                # Documentation files (like this one)
│   │   ├── Agents.md
│   │   ├── FileTree.md
│   │   ├── Roadmap.md
│   │   ├── Schema.md
│   │   └── System.md
│   ├── prisma/              # Prisma configuration and generated client
│   │   └── schema.prisma    # The single source of truth for the database schema
│   ├── scripts/             # Utility scripts for setup, testing, running
│   │   ├── generate_sample_data.py # Creates sample CSVs in data/
│   │   ├── generate_schema.py    # Orchestrates schema suggestion, user review (manual), and DB setup
│   │   ├── run_api.py            # Simple script to run the FastAPI server using uvicorn
│   │   └── test_workflow.py      # Script for end-to-end testing of the analysis workflow
│   ├── src/                 # Main source code package
│   │   ├── __init__.py
│   │   ├── api/             # FastAPI application and endpoints
│   │   │   ├── __init__.py
│   │   │   ├── main.py      # Creates FastAPI app instance, includes routers, middleware
│   │   │   ├── models.py    # Pydantic models for API request/response validation
│   │   │   └── routers/     # API route modules
│   │   │       ├── __init__.py
│   │   │       └── analysis.py # Endpoints for /analyze, /execute, /history
│   │   │
│   │   ├── data_handling/   # Modules for data loading, DB interaction (SQLAlchemy utils), and analysis
│   │   │   ├── __init__.py
│   │   │   ├── loader.py    # Loads CSVs into SQLite using pandas/SQLAlchemy (called after schema setup)
│   │   │   ├── db_utils.py  # SQLAlchemy utilities for summaries (used by context provider)
│   │   │   └── dataset_analysis.py # Performs detailed statistical analysis on datasets (optional step)
│   │   │
│   │   ├── llm/             # Modules for LLM interaction
│   │   │   ├── __init__.py
│   │   │   ├── client.py    # Wrapper for OpenAI API calls, handles history (in-memory)
│   │   │   └── prompts.py   # Stores and formats prompt templates for all agents/tasks
│   │   │
│   │   ├── agents/          # Logic specific to each agent's role
│   │   │   ├── __init__.py
│   │   │   ├── planner.py   # Generates conceptual plans or insight suggestions
│   │   │   ├── plan_validator.py # Validates and refines the planner's output
│   │   │   ├── sql_generator.py # Generates SQL, includes validation, refinement, and debugging logic
│   │   │   └── interpreter.py # Interprets SQL results into natural language
│   │   │
│   │   ├── orchestration/   # Core workflow management
│   │   │   ├── __init__.py
│   │   │   └── workflow.py  # Orchestrates agent calls, manages state (in-memory), handles async flow
│   │   │
│   │   ├── prisma_utils/    # Utilities specifically for interacting with Prisma and the DB via Prisma
│   │   │   ├── __init__.py
│   │   │   ├── context.py   # Generates the rich DB context string using schema and summaries
│   │   │   ├── executor.py  # Executes SQL queries using Prisma Client (async/sync/fallback)
│   │   │   └── analysis_loader.py # Loads pre-computed analysis results
│   │   │
│   │   ├── schema_generator/ # Modules for suggesting the initial Prisma schema
│   │   │   ├── __init__.py
│   │   │   ├── sampler.py   # Samples data from CSV files
│   │   │   └── suggest.py   # Orchestrates sampling, LLM call, and basic validation for schema suggestion
│   │   │
│   │   └── utils/           # Shared utilities
│   │       ├── __init__.py
│   │       └── intent_classifier.py # Classifies user query intent (specific, analytical, descriptive)
│   │
│   └── tests/               # Unit and integration tests
│       ├── __init__.py
│       ├── data_handling/   # Tests for data loading, db utils, analysis
│       │   ├── conftest.py
│       │   └── test_db_utils.py
│       └── ...              # (Other test directories for api, agents, llm, etc. - TBD)
│
└── frontend/                # (Separate directory for a potential web frontend)
    └── ...
```

**Key Components & Structure:**

1.  **`prisma/schema.prisma`:** The definitive source for the database structure. Managed via the schema generation workflow.
2.  **`src/`:** Contains all core application logic, organized by function (api, agents, data_handling, llm, orchestration, prisma_utils, schema_generator, utils).
3.  **`src/api/`:** Handles web requests using FastAPI, defining request/response models (Pydantic) and routing logic.
4.  **`src/orchestration/workflow.py`:** The central brain, coordinating calls between agents, managing state (currently in-memory), and handling the overall analysis flow (including async operations).
5.  **`src/agents/`:** Encapsulates the specific tasks performed by LLMs (planning, validating, SQL generation, interpretation, debugging).
6.  **`src/llm/`:** Manages interaction with the LLM API (OpenAI) and stores prompt templates.
7.  **`src/prisma_utils/`:** Provides essential functions for interacting with the database *through the lens of the Prisma schema*, including context generation and SQL execution.
8.  **`src/data_handling/`:** Contains utilities for loading data (`loader.py`), getting basic DB summaries via SQLAlchemy (`db_utils.py`), and performing deeper statistical analysis (`dataset_analysis.py`).
9.  **`src/schema_generator/`:** Handles the initial step of suggesting a Prisma schema based on CSV data.
10. **`src/utils/`:** Contains shared helper modules like the `intent_classifier.py`.
11. **`scripts/`:** Provides command-line tools for common development tasks like generating data, setting up the schema, and running tests or the API.
12. **`analysis_results/`:** Stores detailed JSON outputs from the optional dataset analysis step, which can enrich the context provided to LLMs.
13. **`analysis.db`:** The SQLite database file itself. Its location is determined by the `DATABASE_URL` in `.env`.
